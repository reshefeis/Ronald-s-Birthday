<script>
    // קבצי אודיו
    const bgMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3');
    bgMusic.loop = true;
    bgMusic.volume = 0.3;

    // רשימת קולות
    const sounds = {
        lion: new Audio('https://assets.mixkit.co/active_storage/sfx/2232/2232-preview.mp3'), // שאגת אריה ברורה
        elephant: new Audio('https://actions.google.com/sounds/v1/animals/elephant_trumpeting.ogg'),
        monkey: new Audio('https://actions.google.com/sounds/v1/animals/monkey_clatter.ogg'),
        applause: new Audio('https://actions.google.com/sounds/v1/human_voices/applause.ogg')
    };

    let lastMilestone = null;

    function startApp() {
        // השמעת מוזיקה וטעינה מראש של הצלילים כדי "לעקוף" חסימת דפדפן
        bgMusic.play().catch(e => console.log("Music blocked"));
        
        // "דריכה" שקטה של הקולות
        Object.values(sounds).forEach(s => {
            s.muted = true;
            s.play().then(() => {
                s.pause();
                s.muted = false;
            }).catch(e => console.log("Preload blocked"));
        });

        document.getElementById('splash-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('splash-screen').style.display = 'none';
            document.getElementById('mainUI').style.display = 'flex';
        }, 800);
    }

    const TARGET_LAT = 32.078286;
    const TARGET_LON = 34.773292;
    let watchId = null;

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; 
        const phi1 = lat1 * Math.PI/180;
        const phi2 = lat2 * Math.PI/180;
        const deltaPhi = (lat2-lat1) * Math.PI/180;
        const deltaLambda = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(deltaPhi/2) * Math.sin(deltaPhi/2) +
                  Math.cos(phi1) * Math.cos(phi2) * Math.sin(deltaLambda/2) * Math.sin(deltaLambda/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
    }

    function startTracking() {
        if (!navigator.geolocation) {
            document.getElementById('log').innerText = "GPS NOT AVAILABLE";
            return;
        }

        document.getElementById('scanBtn').disabled = true;
        document.getElementById('log').innerText = "SEARCHING FOR TRACKS...";
        
        // שאגת אריה מיד עם הפעלת ה-GPS
        sounds.lion.play().catch(e => console.log("Lion sound blocked"));

        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const dist = calculateDistance(position.coords.latitude, position.coords.longitude, TARGET_LAT, TARGET_LON);
                const display = document.getElementById('displayArea');
                const arrivalMsg = document.getElementById('arrivalContent');
                const scanner = document.getElementById('scannerLine');

                const currentMilestone = Math.floor(dist / 10);
                if (lastMilestone !== null && currentMilestone < lastMilestone) {
                    // התקרב ב-10 מטר - משמיע פיל או קוף רנדומלי
                    const randomChoice = Math.random() > 0.5 ? sounds.elephant : sounds.monkey;
                    randomChoice.play();
                }
                lastMilestone = currentMilestone;

                if (dist <= 15) {
                    display.style.display = "none";
                    scanner.style.display = "none";
                    arrivalMsg.style.display = "block";
                    document.getElementById('log').innerText = "TRACKS FOUND! ENTER THE ZONE.";
                    bgMusic.pause(); 
                    sounds.applause.play();
                    navigator.geolocation.clearWatch(watchId);
                } else {
                    display.innerHTML = Math.round(dist) + "<span style='font-size:1rem'>m</span>";
                    document.getElementById('log').innerText = "ANIMAL TRACKS DETECTED...";
                }
            },
            (err) => {
                document.getElementById('log').innerText = "SIGNAL LOST: " + err.message;
                document.getElementById('scanBtn').disabled = false;
            },
            { enableHighAccuracy: true }
        );
    }
</script>